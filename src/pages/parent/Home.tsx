// ============================================
// Petit Stay - Parent Home Page
// ============================================

import { Link } from 'react-router-dom';
import { useTranslation } from 'react-i18next';
import { Calendar, ClipboardList, Baby, Building2, Star, User } from 'lucide-react';
import { Card, CardBody } from '../../components/common/Card';
import { Button } from '../../components/common/Button';
import { StatusBadge } from '../../components/common/Badge';
import { EmptyState } from '../../components/common/EmptyState';
import { Skeleton, CardSkeleton } from '../../components/common/Skeleton';
import { useAuth } from '../../contexts/AuthContext';
import { useParentBookings } from '../../hooks/useBookings';
import '../../styles/pages/parent-home.css';



export default function Home() {
  const { t, i18n } = useTranslation();
  const { user } = useAuth();
  const { upcomingBooking, recentSessions, isLoading } = useParentBookings(user?.id);

  const formatDate = (date: Date) => {
    return new Intl.DateTimeFormat(i18n.language, { month: 'short', day: 'numeric', year: 'numeric' }).format(date);
  };

  // Get time of day for greeting
  const getTimeOfDay = () => {
    const hour = new Date().getHours();
    if (hour < 12) return t('parent.morning');
    if (hour < 18) return t('parent.afternoon');
    return t('parent.evening');
  };

  if (isLoading) {
    return (
      <div className="parent-home animate-fade-in">
        <div className="welcome-section">
          <Skeleton width="70%" height="2.5rem" />
          <Skeleton width="50%" height="1rem" className="mt-2" />
        </div>
        <div className="quick-actions">
          <Skeleton width="100%" height="60px" borderRadius="var(--radius-lg)" />
          <Skeleton width="100%" height="60px" borderRadius="var(--radius-lg)" />
          <Skeleton width="100%" height="60px" borderRadius="var(--radius-lg)" />
        </div>
        <div className="home-stats">
          <Skeleton width="100%" height="80px" borderRadius="var(--radius-lg)" />
          <Skeleton width="100%" height="80px" borderRadius="var(--radius-lg)" />
          <Skeleton width="100%" height="80px" borderRadius="var(--radius-lg)" />
        </div>
        <CardSkeleton />
        <div className="section mt-4">
          <Skeleton width="40%" height="1.5rem" />
          <div className="mt-4">
            <CardSkeleton />
          </div>
          <div className="mt-4">
            <CardSkeleton />
          </div>
        </div>
      </div>
    );
  }

  return (
    <div className="parent-home animate-fade-in">
      {/* Welcome */}
      <div className="welcome-section">
        <h1>{t('parent.greeting', { timeOfDay: getTimeOfDay(), name: user?.profile?.firstName || 'Guest' })} ðŸ‘‹</h1>
        <p>{t('parent.childcareHandled')}</p>
      </div>

      {/* Quick Actions */}
      <div className="quick-actions animate-stagger" role="navigation" aria-label="Quick actions">
        <Link to="/parent/book" className="quick-action-btn">
          <span className="icon" aria-hidden="true"><Calendar size={20} strokeWidth={1.75} /></span>
          <span>{t('parent.bookNow')}</span>
        </Link>
        <Link to="/parent/history" className="quick-action-btn">
          <span className="icon" aria-hidden="true"><ClipboardList size={20} strokeWidth={1.75} /></span>
          <span>{t('nav.history')}</span>
        </Link>
        <Link to="/parent/profile" className="quick-action-btn">
          <span className="icon" aria-hidden="true"><Baby size={20} strokeWidth={1.75} /></span>
          <span>{t('parent.children')}</span>
        </Link>
      </div>

      {/* Dashboard Stats */}
      <div className="home-stats">
        <div className="stat-card">
          <span className="stat-value">{recentSessions.length}</span>
          <span className="stat-label">{t('parent.totalSessions', 'Sessions')}</span>
        </div>
        <div className="stat-card">
          <span className="stat-value">
            {recentSessions.length > 0
              ? (recentSessions.reduce((sum, s) => sum + s.rating, 0) / recentSessions.length).toFixed(1)
              : 'â€”'}
          </span>
          <span className="stat-label">{t('parent.avgRating', 'Avg Rating')}</span>
        </div>
        <div className="stat-card">
          <span className="stat-value">{upcomingBooking?.childrenIds?.length || 0}</span>
          <span className="stat-label">{t('parent.children', 'Children')}</span>
        </div>
      </div>

      {/* Upcoming Booking */}
      {upcomingBooking ? (
        <Card className="upcoming-card" variant="gold">
          <CardBody>
            <div className="upcoming-header">
              <h3>{t('parent.upcomingBooking')}</h3>
              <StatusBadge status={upcomingBooking.status} />
            </div>
            <div className="upcoming-details">
              <span aria-hidden="true"><Calendar size={20} strokeWidth={1.75} /></span>
              <span>{t('parent.tonight')} â€¢ {upcomingBooking.time}</span>
              <div className="detail-row">
                <span aria-hidden="true"><Building2 size={16} strokeWidth={1.75} /></span>
                <span>{upcomingBooking.hotel} - {t('common.room')} {upcomingBooking.room}</span>
              </div>
              <div className="detail-row">
                <span aria-hidden="true"><User size={16} strokeWidth={1.75} /></span>
                <span>{upcomingBooking.sitter.name} <span aria-label={`rated ${upcomingBooking.sitter.rating} stars`}><Star size={14} strokeWidth={1.75} fill="currentColor" /> {upcomingBooking.sitter.rating}</span></span>
              </div>
              <div className="detail-row">
                <span aria-hidden="true"><Baby size={16} strokeWidth={1.75} /></span>
                <span>{upcomingBooking.childrenIds.length} {t('parent.children').toLowerCase()}</span>
              </div>
            </div>
            <div className="upcoming-actions">
              <Link to={`/parent/trust-checkin/${upcomingBooking.id}`}>
                <Button variant="gold" fullWidth>
                  {t('parent.trustCheckIn')}
                </Button>
              </Link>
              <Link to={`/parent/qr/${upcomingBooking.id}`} style={{ marginTop: '0.5rem', display: 'block' }}>
                <Button variant="secondary" fullWidth>
                  {t('parent.showQRCode')}
                </Button>
              </Link>
            </div>
          </CardBody>
        </Card>
      ) : (
        <EmptyState
          icon={<Calendar size={20} strokeWidth={1.75} />}
          title={t('parent.noUpcomingBookings', 'No upcoming bookings')}
          description={t('parent.noUpcomingBookingsDesc', 'Book a trusted sitter for your next hotel stay.')}
          action={
            <Link to="/parent/book">
              <Button variant="gold">{t('parent.bookNow', 'Book Now')}</Button>
            </Link>
          }
        />
      )}

      {/* Recent Sessions */}
      <div className="section animate-stagger">
        <h2 className="section-title">{t('parent.recentSessions')}</h2>
        {recentSessions.length > 0 ? (
          recentSessions.map((session) => (
            <Card key={session.id} className="session-card">
              <CardBody>
                <div className="session-info">
                  <div>
                    <span className="session-date">{formatDate(session.date)}</span>
                    <span className="session-hotel">{session.hotel}</span>
                  </div>
                  <div className="session-meta">
                    <span>{session.durationHours}h</span>
                    <span aria-label={`${session.rating} star rating`}>{Array.from({ length: session.rating }, (_, i) => <Star key={i} size={14} strokeWidth={1.75} fill="currentColor" />)}</span>
                  </div>
                </div>
              </CardBody>
            </Card>
          ))
        ) : (
          <EmptyState
            icon={<ClipboardList size={20} strokeWidth={1.75} />}
            title={t('parent.noRecentSessions', 'No recent sessions')}
            description={t('parent.noRecentSessionsDesc', 'Your completed sessions will appear here.')}
          />
        )}
      </div>
    </div>
  );
}
